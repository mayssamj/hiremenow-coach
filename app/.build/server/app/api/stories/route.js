"use strict";(()=>{var e={};e.id=9655,e.ids=[9655],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},18308:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>q,patchFetch:()=>R,requestAsyncStorage:()=>g,routeModule:()=>f,serverHooks:()=>w,staticGenerationAsyncStorage:()=>x});var n={};r.r(n),r.d(n,{GET:()=>p,POST:()=>m,PUT:()=>h,dynamic:()=>l});var s=r(79182),a=r(72007),i=r(56719),o=r(93442),u=r(53524),c=r(11826);let l="force-dynamic",d=new u.PrismaClient;async function p(e){try{let t=(0,c.bs)(e),r=(0,c.mk)(t),{searchParams:n}=new URL(e.url),s=n.get("search"),a=n.get("tags")?.split(",").filter(Boolean)||[],i="true"===n.get("public"),u={};if((0,c.GJ)(r)||(i?u.isPublic=!0:u.OR=[{userId:r.id},{isPublic:!0}]),s){let e=[{title:{contains:s,mode:"insensitive"}},{content:{contains:s,mode:"insensitive"}},{situation:{contains:s,mode:"insensitive"}},{task:{contains:s,mode:"insensitive"}},{action:{contains:s,mode:"insensitive"}},{result:{contains:s,mode:"insensitive"}},{reflection:{contains:s,mode:"insensitive"}}];u.OR?(u.AND=[{OR:u.OR},{OR:e}],delete u.OR):u.OR=e}if(a.length>0){let e={tags:{some:{tag:{name:{in:a}}}}};u.AND?u.AND.push(e):u.OR&&!s?(u.AND=[{OR:u.OR},e],delete u.OR):u.tags=e.tags}let l=await d.story.findMany({where:u,orderBy:{updatedAt:"desc"},include:{user:{select:{id:!0,username:!0}},tags:{include:{tag:!0}},questions:{include:{question:{include:{companyQuestions:{include:{company:!0}}}}}}}});return o.NextResponse.json(l)}catch(e){if(console.error("Error fetching stories:",e),e instanceof Error&&"Authentication required"===e.message)return o.NextResponse.json({error:"Authentication required"},{status:401});return o.NextResponse.json({error:"Failed to fetch stories"},{status:500})}}async function m(e){try{let t=(0,c.bs)(e),r=(0,c.mk)(t),{title:n,content:s,situation:a,task:i,action:u,result:l,reflection:p,tags:m=[],isPublic:h=!1}=await e.json(),f=await d.story.create({data:{title:n,content:s||"",situation:a,task:i,action:u,result:l,reflection:p,isPublic:h,userId:r.id}});if(m.length>0){let e=m.map(async e=>await d.tag.findUnique({where:{name:e}})||await d.tag.create({data:{name:e,color:y()}})),t=(await Promise.all(e)).map(e=>d.storyTag.create({data:{storyId:f.id,tagId:e.id}}));await Promise.all(t)}let g=await d.story.findUnique({where:{id:f.id},include:{user:{select:{id:!0,username:!0}},tags:{include:{tag:!0}},questions:{include:{question:{include:{companyQuestions:{include:{company:!0}}}}}}}});return o.NextResponse.json(g,{status:201})}catch(e){if(console.error("Error creating story:",e),e instanceof Error&&"Authentication required"===e.message)return o.NextResponse.json({error:"Authentication required"},{status:401});return o.NextResponse.json({error:"Failed to create story"},{status:500})}}async function h(e){try{let t=(0,c.bs)(e),r=(0,c.mk)(t),{id:n,title:s,content:a,situation:i,task:u,action:l,result:p,reflection:m,tags:h=[],isPublic:f}=await e.json(),g=await d.story.findUnique({where:{id:n},select:{userId:!0}});if(!g)return o.NextResponse.json({error:"Story not found"},{status:404});if(!(0,c.GJ)(r)&&g.userId!==r.id)return o.NextResponse.json({error:"Access denied"},{status:403});let x={title:s,content:a||"",situation:i,task:u,action:l,result:p,reflection:m};if(void 0!==f&&(x.isPublic=f),await d.story.update({where:{id:n},data:x}),await d.storyTag.deleteMany({where:{storyId:n}}),h.length>0){let e=h.map(async e=>await d.tag.findUnique({where:{name:e}})||await d.tag.create({data:{name:e,color:y()}})),t=(await Promise.all(e)).map(e=>d.storyTag.create({data:{storyId:n,tagId:e.id}}));await Promise.all(t)}let w=await d.story.findUnique({where:{id:n},include:{user:{select:{id:!0,username:!0}},tags:{include:{tag:!0}},questions:{include:{question:{include:{companyQuestions:{include:{company:!0}}}}}}}});return o.NextResponse.json(w)}catch(e){if(console.error("Error updating story:",e),e instanceof Error&&"Authentication required"===e.message)return o.NextResponse.json({error:"Authentication required"},{status:401});if(e instanceof Error&&"Access denied"===e.message)return o.NextResponse.json({error:"Access denied"},{status:403});return o.NextResponse.json({error:"Failed to update story"},{status:500})}}function y(){let e=["#3B82F6","#10B981","#F59E0B","#EF4444","#8B5CF6","#06B6D4","#84CC16","#F97316","#EC4899","#6366F1"];return e[Math.floor(Math.random()*e.length)]}let f=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/stories/route",pathname:"/api/stories",filename:"route",bundlePath:"app/api/stories/route"},resolvedPagePath:"/home/ubuntu/em_interview_prep/app/app/api/stories/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:g,staticGenerationAsyncStorage:x,serverHooks:w}=f,q="/api/stories/route";function R(){return(0,i.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:x})}},11826:(e,t,r)=>{r.d(t,{GJ:()=>f,Gv:()=>l,MY:()=>m,RA:()=>d,bs:()=>y,c_:()=>c,kF:()=>g,mk:()=>x,nX:()=>h,rV:()=>q,ts:()=>w,uo:()=>R});var n=r(3390),s=r.n(n),a=r(49165),i=r.n(a),o=r(83378);let u=process.env.JWT_SECRET||"your-secret-key-change-in-production";async function c(e){return s().hash(e,12)}async function l(e,t){return s().compare(e,t)}function d(e){return i().sign({id:e.id,username:e.username,role:e.role,preferredCompany:e.preferredCompany},u,{expiresIn:"7d"})}function p(e){try{let t=i().verify(e,u);return{id:t.id,username:t.username,role:t.role,preferredCompany:t.preferredCompany}}catch(e){return null}}async function m(e){let t=d(e);(0,o.cookies)().set("auth-token",t,{httpOnly:!0,secure:!0,sameSite:"lax",maxAge:604800,path:"/"})}async function h(){try{let e=(0,o.cookies)(),t=e.get("auth-token")?.value;if(!t)return null;return p(t)}catch(e){return null}}function y(e){try{let t=e.cookies.get("auth-token")?.value;if(!t)return null;return p(t)}catch(e){return null}}function f(e){return e?.role==="ADMIN"}function g(e){if(!e||"ADMIN"!==e.role)throw Error("Admin access required");return e}function x(e){if(!e)throw Error("Authentication required");return e}async function w(){return h()}function q(e){return!e||e.length<3?"Username must be at least 3 characters long":e.length>30?"Username must be less than 30 characters":/^[a-zA-Z0-9_-]+$/.test(e)?null:"Username can only contain letters, numbers, underscores, and hyphens"}function R(e){return!e||e.length<6?"Password must be at least 6 characters long":e.length>100?"Password must be less than 100 characters":null}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[4372,7609,6871],()=>r(18308));module.exports=n})();